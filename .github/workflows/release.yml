name: Release
on:
  - workflow_dispatch

env:
  UV_VERSION: 0.10.4

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    outputs:
      version: ${{ steps.create_release.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          version: ${{ env.UV_VERSION }}

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Create Release
        id: create_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=$(uv version --short)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          uv run scriv print --version $VERSION --output release-body
          gh release create "v${VERSION}" \
            --title  ${VERSION} \
            --target "${{ github.sha }}" \
            --notes-file release-body

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1
        with:
          mark_as_latest: false
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

  docker-publish:
    name: Docker publish
    permissions:
      contents: write
    needs:
     - release
    uses: ./.github/workflows/docker-build.yml
    with:
      tag: ${{ needs.release.outputs.version }}
    secrets: inherit

